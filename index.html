<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MALUCO — Website</title>
<meta name="description" content="MALUCO — pre-reservations of the album (standard and definitive edition)." />
<link rel="icon" href="favicon.ico" />

<!-- (4) Performance: preconnects for Firebase -->
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="preconnect" href="https://www.googleapis.com" crossorigin>

<!-- Open Graph -->
<meta property="og:title" content="MALUCO" />
<meta property="og:description" content="Pre-reservations available. See the product, choose an edition, and reserve with no cost." />
<meta property="og:type" content="website" />
<meta property="og:image" content="400x400.jpg" />

<!-- (10) Deployment notes:
  - Add your domain to Firebase Auth → Settings → Authorized domains
  - Consider separate Firebase projects for dev/prod
-->

<style>
  :root {
    --bg-light: linear-gradient(120deg, #fdfbfb, #ebedee);
    --bg-dark:  linear-gradient(120deg, #1e1e1e, #121212);
    --text-light: #000;
    --text-dark:  #fff;
    --muted: #444;
    --muted-dark: #ccc;
    --card: #fff;
    --card-dark: #222;
    --btn: #ccc;
    --btn-dark: #444;
    --btn-hover: #bbb;
    --btn-dark-hover: #555;
    --shadow: 0 2px 6px rgba(0,0,0,0.1);
    --shadow-lg: 0 8px 20px rgba(0,0,0,0.2);
    --focus: #6aa9ff;
    --nav-light: #f5f5f5;
    --nav-dark: #222;
    --accent: #6aa9ff33;
  }

  * { box-sizing: border-box; }
  html, body { height: 100%; }

  body {
    margin: 0;
    font-family: 'Trebuchet MS', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    background: var(--bg-light);
    color: var(--text-light);
    scroll-behavior: smooth;
    transition: background 0.5s ease, color 0.5s ease;
    overflow-x: hidden;
  }
  body.dark { background: var(--bg-dark); color: var(--text-dark); }

  :focus-visible { outline: 3px solid var(--focus); outline-offset: 2px; border-radius: 6px; }

  /* Navigation */
  nav {
    background: var(--nav-light);
    padding: 12px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    position: sticky;
    top: 0;
    z-index: 1000;
    box-shadow: var(--shadow);
  }
  body.dark nav { background: var(--nav-dark); }
  .brand { font-weight: 800; letter-spacing: 0.5px; }
  .menu { display: flex; gap: 20px; align-items: center; }
  .menu a, .menu button.btn-link {
    background: none; border: none; padding: 0;
    text-decoration: none; color: inherit; font-size: 16px; font-weight: 700;
    transition: opacity 0.2s ease;
    cursor: pointer;
    position: relative;
  }
  .menu a:hover, .menu button.btn-link:hover { opacity: 0.7; }
  /* underline slide animation on click */
  .menu a::after, .menu button.btn-link::after {
    content:""; position:absolute; left:0; right:100%; bottom:-4px; height:2px;
    background: currentColor; transition:right .3s ease;
  }
  .menu a.clicked::after, .menu button.btn-link.clicked::after { right:0; }

  .menu-toggle {
    display: block;
    background: none;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: inherit;
  }
  @media (min-width: 769px) {
    .menu-toggle { display: none; }
    nav .menu { display: flex !important; }
  }
  @media (max-width: 768px) {
    nav { flex-wrap: wrap; gap: 8px; }
    nav .menu {
      display: none;
      width: 100%;
      flex-direction: column;
      gap: 12px;
      margin-top: 8px;
    }
    nav .menu.show { display: flex; }
  }

  /* Sections */
  .section {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    padding: 56px 20px;
    opacity: 0;
    transform: translateY(30px);
    transition: opacity 0.8s ease, transform 0.8s ease, box-shadow .6s ease;
    scroll-margin-top: 80px;
    text-align: center;
  }
  .section.visible { opacity: 1; transform: translateY(0); }

  /* (nav click) highlight animation on target section */
  @keyframes targetHighlight {
    0%   { box-shadow: 0 0 0 0 var(--accent); }
    50%  { box-shadow: 0 0 0 16px var(--accent); }
    100% { box-shadow: 0 0 0 0 var(--accent); }
  }
  .section.target-pulse { animation: targetHighlight 800ms ease; border-radius: 14px; }

  /* Home */
  #home h1 { font-size: clamp(2rem, 4vw, 3rem); margin: 10px 0 10px; }
  #countdown { font-size: 1.25rem; margin: 16px 0 8px; display: flex; gap: 6px; }
  .flip-digit {
    background: var(--card);
    color: var(--text-light);
    padding: 10px 14px;
    border-radius: 10px;
    box-shadow: var(--shadow);
    display: inline-block;
    perspective: 1000px;
    position: relative;
    min-width: 60px;
  }
  .flip-digit-inner { display: block; transition: transform 0.6s; transform-style: preserve-3d; }
  .flip-digit-top, .flip-digit-bottom { backface-visibility: hidden; display: block; }
  .flip-digit-bottom { transform: rotateX(180deg); position: absolute; inset: 0; }
  body.dark .flip-digit { background: #333; color: #fff; }
  body.dark .flip-digit-top, body.dark .flip-digit-bottom { color: #fff; }

  .hero-img {
    border-radius: 12px;
    box-shadow: var(--shadow);
    cursor: pointer;
    margin-top: 12px;
    max-width: 90vw;
    height: auto;
  }

  /* Shop */
  .shop-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 28px;
    width: min(1100px, 92vw);
    margin: 0 auto;
  }
  .product {
    background: var(--card);
    color: inherit;
    border: none;
    text-align: center;
    cursor: pointer;
    width: 100%;
    padding: 14px;
    border-radius: 12px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    box-shadow: var(--shadow);
  }
  .product:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
  .product img { width: 100%; height: auto; border-radius: 10px; transition: transform 0.25s ease; }
  .product:hover img { transform: scale(1.03); }
  .product h2 { font-size: 1.35rem; margin: 10px 0 6px; }
  .product p { margin: 4px 0; color: var(--muted); }
  body.dark .product { background: var(--card-dark); }
  body.dark .product p { color: var(--muted-dark); }

  /* Modal (product & auth share same base classes) */
  .modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    padding: 12px;
    opacity: 0;
    transition: opacity 0.35s ease;
  }
  .modal.show { display: flex; opacity: 1; }
  .modal-content {
    background: var(--card);
    color: inherit;
    padding: 20px;
    border-radius: 12px;
    width: 100%;
    max-width: 420px;
    text-align: center;
    transform: translateY(-16px) scale(0.96);
    transition: transform 0.35s ease, opacity 0.35s ease;
    opacity: 0;
    box-shadow: var(--shadow-lg);
  }
  .modal.show .modal-content { transform: translateY(0) scale(1); opacity: 1; }
  .modal-content img { width: 80%; height: auto; margin: 0 auto 14px; border-radius: 10px; display: block; }
  body.dark .modal-content { background: var(--card-dark); }

  /* Buttons */
  button, .btn {
    background: var(--btn);
    color: #000;
    border: none;
    border-radius: 22px;
    padding: 12px 22px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.2s, transform 0.15s;
  }
  button:hover, .btn:hover { background: var(--btn-hover); transform: translateY(-1px); }
  body.dark button, body.dark .btn { background: var(--btn-dark); color: #fff; }
  body.dark button:hover, body.dark .btn:hover { background: var(--btn-dark-hover); }

  /* Settings */
  #settings h2 { margin-bottom: 16px; }
  .audioControl { margin-top: 12px; font-size: 18px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
  input[type=range] { width: 220px; }
  @media (max-width: 768px) { #volumeSlider { display: none; } }

  /* Footer */
  .copyright { text-align: center; margin: 24px 0 10px; font-size: 12px; color: #888; }

  /* Success toast */
  .toast {
    position: fixed; left: 50%; top: 14px; transform: translateX(-50%);
    background: #1f9d55; color: #fff; padding: 10px 16px; border-radius: 10px;
    box-shadow: var(--shadow-lg); z-index: 2000; opacity: 0; transition: opacity .3s ease;
  }
  .toast.show { opacity: 1; }
</style>
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="brand">MALUCO</div>
    <button class="menu-toggle" type="button" aria-controls="mainmenu" aria-expanded="false" onclick="toggleMenu()">☰</button>
    <div class="menu" id="mainmenu" role="navigation" aria-label="Main">
      <a href="#home" data-target="home" class="nav-link">Home</a>
      <a href="#shop" data-target="shop" class="nav-link">Shop</a>
      <a href="#settings" data-target="settings" class="nav-link">Settings</a>
      <button id="accountBtn" class="btn btn-link" type="button" onclick="openAuthModal()">Account</button>
    </div>
  </nav>

  <!-- Home -->
  <section id="home" class="section">
    <h1>MALUCO</h1>
    <div id="countdown" aria-live="polite">
      <div class="flip-digit" aria-label="Days"><div class="flip-digit-inner"><span class="flip-digit-top">0d</span><span class="flip-digit-bottom">0d</span></div></div>
      <div class="flip-digit" aria-label="Hours"><div class="flip-digit-inner"><span class="flip-digit-top">0h</span><span class="flip-digit-bottom">0h</span></div></div>
      <div class="flip-digit" aria-label="Minutes"><div class="flip-digit-inner"><span class="flip-digit-top">0m</span><span class="flip-digit-bottom">0m</span></div></div>
      <div class="flip-digit" aria-label="Seconds"><div class="flip-digit-inner"><span class="flip-digit-top">0s</span><span class="flip-digit-bottom">0s</span></div></div>
    </div>

    <img class="hero-img" src="400x400.jpg" alt="MALUCO album" width="400" height="400"
         onclick="document.getElementById('shop').scrollIntoView({behavior:'smooth'})" />
  </section>

  <!-- Shop -->
  <section id="shop" class="section">
    <div class="shop-grid">
      <button class="product" type="button" onclick="openModal('standard')">
        <img src="400x400.jpg" alt="MALUCO standard edition" width="400" height="400" loading="lazy" />
        <h2>MALUCO</h2>
        <p><strong>$3</strong></p>
        <p>Pre-orders available now</p>
      </button>

      <button class="product" type="button" onclick="openModal('definitive')">
        <img src="500x500.jpg" alt="MALUCO definitive edition" width="500" height="500" loading="lazy" />
        <h2>MALUCO (Definitive Edition)</h2>
        <p><strong>$5</strong></p>
        <p>Pre-orders available now</p>
      </button>
    </div>
  </section>

  <!-- Settings -->
  <section id="settings" class="section">
    <h2>Settings</h2>
    <div class="audioControl">
      <button type="button" onclick="toggleMusic()">Play / Pause Music</button>
      <label for="volumeSlider">Volume:</label>
      <input type="range" min="0" max="1" step="0.01" id="volumeSlider" onchange="setVolume(this.value)" />
      <button type="button" onclick="toggleTheme()">Toggle Dark Theme</button>
    </div>
  </section>

  <!-- Product Modal -->
  <div class="modal" id="productModal" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-hidden="true">
    <div class="modal-content">
      <h2 id="modalTitle">MALUCO — $3</h2>
      <img id="modalAlbum" src="400x400.jpg" alt="Album" width="400" height="400" />
      <p>This is a reservation — <strong>we won't charge you now</strong>.</p>

      <button id="buyButton" type="button" class="btn" onclick="showForm()">Reserve</button>

      <div id="formArea" style="display:none; margin-top:10px;">
        <form id="preorderForm" action="https://formspree.io/f/mvgwpkkq" method="POST">
          <!-- (3) Honeypot anti-spam -->
          <input type="text" name="_gotcha" tabindex="-1" autocomplete="off" style="display:none">
          <label for="email">Email</label><br />
          <input id="email" type="email" name="email" placeholder="your@email.com" required /><br /><br />
          <label><input type="checkbox" name="interest" required /> I want to reserve this product</label><br /><br />
          <button id="submitBtn" type="submit" class="btn">Confirm Reservation</button>
        </form>
        <div id="formStatus" style="margin-top:10px;"></div>
      </div>

      <br />
      <button type="button" class="btn" onclick="closeModal()">Close</button>
    </div>
  </div>

  <!-- Account / Auth Modal -->
  <div class="modal" id="authModal" role="dialog" aria-modal="true" aria-labelledby="authTitle" aria-hidden="true">
    <div class="modal-content">
      <h2 id="authTitle">Sign in</h2>

      <button type="button" class="btn" id="googleSignInBtn">Continue with Google</button>

      <div style="margin:10px 0; opacity:.6;">or</div>

      <form id="emailAuthForm" onsubmit="return false;">
        <label for="authEmail">Email</label><br />
        <input id="authEmail" type="email" placeholder="you@example.com" required /><br /><br />
        <label for="authPass">Password</label><br />
        <input id="authPass" type="password" minlength="6" placeholder="••••••••" required /><br /><br />
        <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
          <button type="button" class="btn" id="emailSignInBtn">Sign in</button>
          <button type="button" class="btn" id="emailSignUpBtn">Create account</button>
          <!-- (2) Password reset -->
          <button type="button" class="btn" id="resetBtn" title="Reset password via email">Reset password</button>
        </div>
      </form>

      <div id="authError" style="color:#c0392b; margin-top:10px; min-height:1.2em;"></div>

      <br />
      <button type="button" class="btn" onclick="closeAuthModal()">Close</button>
    </div>
  </div>

  <!-- Music -->
  <audio id="bgMusic" loop>
    <source src="ALONE.mp3" type="audio/mpeg" />
    Your browser does not support audio.
  </audio>

  <!-- toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Signed-in indicator (optional) -->
  <div id="whoami" class="copyright"></div>
  <div class="copyright">© 2025 ME100</div>

<!-- ===== Firebase (Auth + optional Firestore) ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-analytics.js";
  import {
    getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
    signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    sendPasswordResetEmail, sendEmailVerification
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
  import {
    getFirestore, doc, setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBUBMX0Nkaml4BoDgTBZsLv15rXd4-yaB0",
    authDomain: "me100-shoop.firebaseapp.com",
    projectId: "me100-shoop",
    storageBucket: "me100-shoop.firebasestorage.app",
    messagingSenderId: "1043376017039",
    appId: "1:1043376017039:web:5606b92f696854658faafa",
    measurementId: "G-LVBT7HM50B"
  };

  const app = initializeApp(firebaseConfig);
  const analytics = getAnalytics(app);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (sel) => document.querySelector(sel);
  const authModal  = $("#authModal");
  const accountBtn = $("#accountBtn");
  const whoami     = $("#whoami");
  const toastEl    = $("#toast");

  function showToast(msg){
    toastEl.textContent = msg;
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), 2200);
  }

  function showAuthModal(){
    authModal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    requestAnimationFrame(()=> {
      authModal.classList.add('show');
      authModal.setAttribute('aria-hidden','false');
    });
  }
  function closeAuthModal(){
    authModal.classList.remove('show');
    authModal.setAttribute('aria-hidden','true');
    document.body.style.overflow = '';
    setTimeout(()=>{ authModal.style.display = 'none'; }, 300);
  }
  window.closeAuthModal = closeAuthModal;

  function openAuthModal() {
    const user = auth.currentUser;
    $("#authError").textContent = "";
    if (user) {
      $("#authTitle").innerText = "Your account";
      $("#emailAuthForm").style.display = "none";
      $("#googleSignInBtn").style.display = "none";
      $("#signoutArea")?.remove();
      $("#authModal .modal-content").insertAdjacentHTML("beforeend",
        `<div id="signoutArea" style="margin-top:10px;">
           <button type="button" class="btn" id="signOutBtn">Sign out</button>
         </div>`);
      showAuthModal();
      $("#signOutBtn").onclick = async () => { await signOut(auth); closeAuthModal(); showToast("Signed out"); };
    } else {
      $("#authTitle").innerText = "Sign in";
      $("#emailAuthForm").style.display = "block";
      $("#googleSignInBtn").style.display = "inline-block";
      $("#signoutArea")?.remove();
      showAuthModal();
    }
  }
  window.openAuthModal = openAuthModal;

  // Auth actions
  $("#googleSignInBtn")?.addEventListener("click", async ()=>{
    try {
      await signInWithPopup(auth, new GoogleAuthProvider());
      closeAuthModal();
      showToast("Signed in with Google");
    } catch (e) { showAuthError(e); }
  });

  $("#emailSignInBtn")?.addEventListener("click", async ()=>{
    const email = $("#authEmail").value.trim();
    const pass  = $("#authPass").value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      closeAuthModal();
      showToast("Signed in");
    } catch (e) { showAuthError(e); }
  });

  $("#emailSignUpBtn")?.addEventListener("click", async ()=>{
    const email = $("#authEmail").value.trim();
    const pass  = $("#authPass").value;
    try {
      await createUserWithEmailAndPassword(auth, email, pass);
      // (2) email verification prompt (optional)
      try { await sendEmailVerification(auth.currentUser); } catch {}
      closeAuthModal();
      showToast("Account created");
    } catch (e) { showAuthError(e); }
  });

  // (2) Password reset
  $("#resetBtn")?.addEventListener("click", async ()=>{
    const email = $("#authEmail").value.trim();
    if (!email) { $("#authError").textContent = "Enter your email above first."; return; }
    try {
      await sendPasswordResetEmail(auth, email);
      $("#authError").textContent = "";
      showToast("Password reset email sent");
    } catch (e) { showAuthError(e); }
  });

  function showAuthError(err){
    const code = err?.code || "";
    const map = {
      "auth/popup-closed-by-user": "Sign-in window was closed.",
      "auth/account-exists-with-different-credential": "This email is linked to another sign-in method.",
      "auth/invalid-credential": "Invalid credentials.",
      "auth/invalid-login-credentials": "Invalid email or password.",
      "auth/email-already-in-use": "Email already in use.",
      "auth/weak-password": "Password should be at least 6 characters."
    };
    $("#authError").textContent = map[code] || err?.message || "Something went wrong.";
  }

  // Keep UI in sync
  onAuthStateChanged(auth, (user)=>{
    if (user) {
      const name = user.displayName || user.email || "User";
      accountBtn.textContent = (name.split("@")[0] || "Account");
      whoami && (whoami.textContent = `Signed in as ${name}`);
    } else {
      accountBtn.textContent = "Account";
      whoami && (whoami.textContent = "");
    }
  });

  // (1) UX: AJAX submit to Formspree + disable button + success state
  const preorderForm = document.querySelector('#preorderForm');
  const submitBtn = document.querySelector('#submitBtn');
  const formArea = document.querySelector('#formArea');
  const formStatus = document.querySelector('#formStatus');

  preorderForm?.addEventListener('submit', async (e)=>{
    e.preventDefault();
    // honeypot
    if (preorderForm.querySelector('input[name="_gotcha"]')?.value) return;

    submitBtn.disabled = true;
    const oldText = submitBtn.textContent;
    submitBtn.textContent = "Submitting…";

    const fd = new FormData(preorderForm);
    try {
      // Optional Firestore write (if signed in)
      const user = auth.currentUser;
      if (user) {
        const isDef = document.getElementById('modalTitle').innerText.includes('Definitive');
        await setDoc(doc(db, 'preorders', `${user.uid}-${Date.now()}`), {
          uid: user.uid,
          email: fd.get('email'),
          sku: isDef ? 'definitive' : 'standard',
          priceUSD: isDef ? 5 : 3,
          createdAt: serverTimestamp()
        });
      }
      // Send to Formspree (expects JSON accept header)
      const res = await fetch(preorderForm.action, {
        method: 'POST',
        body: fd,
        headers: { 'Accept': 'application/json' }
      });
      if (res.ok) {
        formArea.innerHTML = '<p style="font-weight:700">✅ Reservation received! Check your inbox for confirmation.</p>';
        showToast("Reservation received");
      } else {
        formStatus.textContent = "Could not submit reservation. Please try again.";
        submitBtn.disabled = false; submitBtn.textContent = oldText;
      }
    } catch (err) {
      console.warn(err);
      formStatus.textContent = "Something went wrong. Please try again.";
      submitBtn.disabled = false; submitBtn.textContent = oldText;
    }
  });

  // If you want to REQUIRE sign-in before showing the form, replace showForm in site logic with auth gate.
</script>

<!-- ===== Site logic ===== -->
<script defer>
  (function initTheme(){
    try {
      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      if ((saved === 'dark') || (!saved && prefersDark)) document.body.classList.add('dark');
    } catch(e) {}
  })();

  (function revealOnScroll(){
    const io = new IntersectionObserver((entries)=>{
      entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('visible'); });
    }, { rootMargin: '0px 0px -100px 0px' });
    document.querySelectorAll('.section').forEach(s => io.observe(s));
  })();

  function next26th(from = new Date()) {
    const y = from.getFullYear(), m = from.getMonth();
    const candidate = new Date(y, m, 26, 0, 0, 0);
    return (from <= candidate) ? candidate : new Date(y, m + 1, 26, 0, 0, 0);
  }

  function updateCountdown() {
    const target = next26th();
    const now    = new Date();
    const diff   = target - now;

    const days    = Math.floor(diff / 86400000);
    const hours   = Math.floor((diff % 86400000) / 3600000);
    const minutes = Math.floor((diff % 3600000) / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);

    const values = [`${days}d`, `${hours}h`, `${minutes}m`, `${seconds}s`];

    document.querySelectorAll(".flip-digit").forEach((digit, i) => {
      const inner  = digit.querySelector('.flip-digit-inner');
      const top    = inner.querySelector('.flip-digit-top');
      const bottom = inner.querySelector('.flip-digit-bottom');
      if (top.innerText !== values[i]) {
        bottom.innerText = values[i];
        inner.style.transform = 'rotateX(-180deg)';
        setTimeout(() => {
          top.innerText = values[i];
          inner.style.transform = 'rotateX(0deg)';
        }, 300);
      }
    });
  }
  setInterval(updateCountdown, 1000);
  updateCountdown();

  let lastFocus;
  function openModal(type) {
    lastFocus = document.activeElement;
    const modal = document.getElementById('productModal');
    const title = document.getElementById('modalTitle');
    const img   = document.getElementById('modalAlbum');

    if (type === 'standard') {
      title.innerText = 'MALUCO — $3';
      img.src = '400x400.jpg';
      img.alt = 'MALUCO standard edition';
      img.width = 400; img.height = 400;
    } else {
      title.innerText = 'MALUCO (Definitive Edition) — $5';
      img.src = '500x500.jpg';
      img.alt = 'MALUCO definitive edition';
      img.width = 500; img.height = 500;
    }

    document.getElementById('buyButton').style.display='inline-block';
    document.getElementById('formArea').style.display='none';

    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    requestAnimationFrame(() => {
      modal.classList.add('show');
      modal.setAttribute('aria-hidden', 'false');
      document.getElementById('buyButton').focus();
    });
  }
  function closeModal(){
    const modal = document.getElementById('productModal');
    modal.classList.remove('show');
    modal.setAttribute('aria-hidden', 'true');
    document.body.style.overflow = '';
    setTimeout(() => { modal.style.display = 'none'; }, 300);
    if (lastFocus) lastFocus.focus();
  }
  window.openModal = openModal;
  window.closeModal = closeModal;

  document.getElementById('productModal').addEventListener('click', (e)=>{
    if (e.target.id === 'productModal') closeModal();
  });
  window.addEventListener('keydown', (e)=>{
    if (e.key === 'Escape') closeModal();
  }, { passive: true });

  function showForm(){
    document.getElementById('formArea').style.display='block';
    document.getElementById('buyButton').style.display='none';
  }
  window.showForm = showForm;

  function toggleMusic(){
    const music = document.getElementById('bgMusic');
    if (music.paused) {
      music.play().catch(()=>{ /* autoplay blocked */ });
    } else {
      music.pause();
    }
  }
  function setVolume(v){ document.getElementById('bgMusic').volume = parseFloat(v); }
  window.toggleMusic = toggleMusic;
  window.setVolume = setVolume;

  function toggleTheme(){
    const dark = document.body.classList.toggle('dark');
    try { localStorage.setItem('theme', dark ? 'dark' : 'light'); } catch(e) {}
  }
  window.toggleTheme = toggleTheme;

  function toggleMenu() {
    const menu = document.getElementById("mainmenu");
    const btn  = document.querySelector(".menu-toggle");
    const open = menu.classList.toggle("show");
    btn.setAttribute("aria-expanded", String(open));
  }
  window.toggleMenu = toggleMenu;

  // (nav click) add pulse animation on target + underline slide on link
  document.querySelectorAll('.nav-link').forEach(link=>{
    link.addEventListener('click', (e)=>{
      // underline slide
      link.classList.add('clicked');
      setTimeout(()=> link.classList.remove('clicked'), 400);

      // section pulse after scroll
      const id = link.getAttribute('data-target');
      const section = document.getElementById(id);
      if (!section) return;
      // delay a bit to let scroll land
      setTimeout(()=>{
        section.classList.add('target-pulse');
        setTimeout(()=> section.classList.remove('target-pulse'), 800);
      }, 200);
    });
  });

  (function konamiInit(){
    const seq = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
    let pos = 0;
    window.addEventListener('keydown', (e)=>{
      const key = e.key.length === 1 ? e.key.toLowerCase() : e.key;
      const normalized = (key.length === 1) ? key : e.key;
      pos = (normalized === seq[pos]) ? pos + 1 : (normalized === seq[0] ? 1 : 0);
      if (pos === seq.length) {
        document.body.style.background = 'linear-gradient(120deg, #6dc8eb, #66c2ef)';
        pos = 0;
      }
    }, { passive: true });
  })();
</script>
</body>
</html>
