<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Website</title>
  <meta name="description" content="Example website" />
  <link rel="icon" href="favicon.ico" />

  <!-- Theme color for mobile -->
  <meta name="theme-color" content="#121212" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)">

  <!-- Performance: preconnects -->
  <link rel="preconnect" href="https://www.gstatic.com" crossorigin>
  <link rel="preconnect" href="https://www.googleapis.com" crossorigin>

  <style>
    :root {
      --bg-light: linear-gradient(120deg, #fdfbfb, #ebedee);
      --bg-dark: linear-gradient(120deg, #1e1e1e, #121212);
      --text-light: #000;
      --text-dark: #fff;
      --muted: #3a3a3a;
      --muted-dark: #d6d6d6;
      --card: #fff;
      --card-dark: #222;
      --btn: #ccc;
      --btn-dark: #444;
      --btn-hover: #bbb;
      --btn-dark-hover: #555;
      --shadow: 0 2px 6px rgba(0,0,0,.1);
      --shadow-lg: 0 8px 20px rgba(0,0,0,.2);
      --focus: #6aa9ff;
      --nav-light: #f5f5f5;
      --nav-dark: #222;
      --accent: #6aa9ff33;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: 'Trebuchet MS', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: var(--bg-light);
      color: var(--text-light);
      scroll-behavior: smooth;
      transition: background .5s, color .5s;
      overflow-x: hidden;
    }
    body.dark { background: var(--bg-dark); color: var(--text-dark); }
    :focus-visible { outline: 3px solid var(--focus); outline-offset: 2px; border-radius: 6px; }
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    nav {
      background: var(--nav-light);
      padding: 12px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: var(--shadow);
    }
    body.dark nav { background: var(--nav-dark); }
    .brand {
      font-weight: 800;
      letter-spacing: .5px;
      cursor: pointer;
      user-select: none;
      transition: transform .25s;
      font-size: 24px;
    }
    .brand.bounce { transform: scale(1.06) translateY(-2px); }
    .menu {
      display: flex;
      gap: 20px;
      align-items: center;
    }
    .menu a, .menu button.btn-link {
      background: none;
      border: none;
      padding: 0;
      text-decoration: none;
      color: inherit;
      font-size: 16px;
      font-weight: 700;
      transition: opacity .2s;
      cursor: pointer;
      position: relative;
    }
    .menu a:hover, .menu button.btn-link:hover { opacity: .7; }
    .menu a::after, .menu button.btn-link::after {
      content: "";
      position: absolute;
      left: 0;
      right: 100%;
      bottom: -4px;
      height: 2px;
      background: currentColor;
      transition: right .3s;
    }
    .menu a.clicked::after, .menu button.btn-link.clicked::after { right: 0; }
    .menu-toggle {
      display: block;
      background: none;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: inherit;
    }
    @media (min-width: 769px) {
      .menu-toggle { display: none; }
      nav .menu { display: flex !important; }
    }
    @media (max-width: 768px) {
      nav { flex-wrap: wrap; gap: 8px; }
      nav .menu {
        display: none;
        width: 100%;
        flex-direction: column;
        gap: 12px;
        margin-top: 8px;
      }
      nav .menu.show { display: flex; }
    }
    .nav-icon { display: inline-flex; align-items: center; gap: 8px; }
    .nav-icon span { font-size: 18px; }
    .menu a[aria-current="true"] { opacity: .85; }

    /* Account chip + menu */
    #accountBtn.account-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: transparent;
      border-radius: 999px;
      padding: 6px 10px;
      box-shadow: none;
      font-weight: 700;
    }
    #accountBtn.account-chip:hover { background: rgba(0,0,0,.06); }
    body.dark #accountBtn.account-chip:hover { background: rgba(255,255,255,.08); }
    #accountBtn .chip-avatar {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-size: 12px;
      font-weight: 800;
      background: #1e88e5;
      color: #fff;
    }
    .acct-menu {
      position: absolute;
      right: 20px;
      top: 58px;
      width: 260px;
      background: var(--card);
      color: inherit;
      border-radius: 12px;
      box-shadow: var(--shadow-lg);
      padding: 10px;
      z-index: 1300;
      display: none;
      opacity: 0;
      transform: translateY(-6px);
      transition: opacity .18s, transform .18s;
    }
    .acct-menu.show {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }
    body.dark .acct-menu { background: var(--card-dark); }
    .acct-header {
      display: flex;
      gap: 10px;
      padding: 8px 10px 12px;
      border-bottom: 1px solid rgba(0,0,0,.08);
    }
    body.dark .acct-header { border-bottom: 1px solid rgba(255,255,255,.08); }
    .acct-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      font-weight: 800;
      background: #1e88e5;
      color: #fff;
      flex: 0 0 auto;
    }
    .acct-name { font-weight: 800; }
    .acct-email { font-size: 12px; opacity: .8; word-break: break-all; }
    .acct-item {
      width: 100%;
      text-align: left;
      background: transparent;
      border: none;
      padding: 10px 10px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 6px;
    }
    .acct-item:hover { background: rgba(0,0,0,.06); }
    body.dark .acct-item:hover { background: rgba(255,255,255,.08); }
    .acct-item.danger { color: #c0392b; }

    .section {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 56px 20px;
      opacity: 0;
      transform: translateY(30px);
      transition: opacity .8s, transform .8s, box-shadow .6s;
      text-align: center;
      scroll-margin-top: 80px;
    }
    .section.visible { opacity: 1; transform: translateY(0); }
    @keyframes targetHighlight {
      0% { box-shadow: 0 0 0 0 var(--accent); }
      50% { box-shadow: 0 0 0 16px var(--accent); }
      100% { box-shadow: 0 0 0 0 var(--accent); }
    }
    .section.target-pulse { animation: targetHighlight 800ms ease; border-radius: 14px; }
    #home h1 { font-size: clamp(2rem, 4vw, 3rem); margin: 10px 0 10px; }

    button, .btn {
      background: var(--btn);
      color: #000;
      border: none;
      border-radius: 22px;
      padding: 12px 22px;
      font-size: 16px;
      cursor: pointer;
      transition: background .2s, transform .15s;
    }
    button:hover, .btn:hover { background: var(--btn-hover); transform: translateY(-1px); }
    body.dark button, body.dark .btn { background: var(--btn-dark); color: #fff; }
    body.dark button:hover, body.dark .btn:hover { background: var(--btn-dark-hover); }

    #settings h2 { margin-bottom: 16px; }
    .audioControl {
      margin-top: 12px;
      font-size: 18px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }
    input[type=range] { width: 220px; }
    @media (max-width: 768px) {
      #volumeSlider { display: none; }
      label[for="volumeSlider"] { display: none; }
      .shortcuts-wrap { display: none; }
    }

    .copyright { text-align: center; margin: 24px 0 10px; font-size: 12px; color: #888; }

    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.5);
      justify-content: center;
      align-items: center;
      padding: 12px;
      opacity: 0;
      transition: opacity .35s;
      z-index: 1200;
    }
    .modal.show { display: flex; opacity: 1; }
    .modal-content {
      background: var(--card);
      color: inherit;
      padding: 20px;
      border-radius: 12px;
      width: 100%;
      max-width: 520px;
      text-align: center;
      transform: translateY(-16px) scale(.96);
      transition: transform .35s, opacity .35s;
      opacity: 0;
      box-shadow: var(--shadow-lg);
    }
    .modal.show .modal-content { transform: translateY(0) scale(1); opacity: 1; }
    body.dark .modal-content { background: var(--card-dark); }

    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--card);
      color: inherit;
      padding: 12px 24px;
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      z-index: 1400;
      opacity: 0;
      transition: opacity .3s, transform .3s;
      font-weight: 600;
    }
    body.dark .toast { background: var(--card-dark); }
    .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
  </style>
</head>
<body>
  <!-- Navigation -->
  <nav>
    <div class="brand" id="brandHome" title="Go Home">üè†</div>
    <button class="menu-toggle" type="button" aria-controls="mainmenu" aria-expanded="false">‚ò∞</button>
    <div class="menu" id="mainmenu" aria-label="Main">
      <a href="#home" data-target="home" class="nav-link" aria-current="true">üè†</a>
      <a href="#settings" data-target="settings" class="nav-link nav-icon" title="Settings" aria-label="Settings">
        <span>‚öô</span>
        <span class="sr-only">Settings</span>
      </a>
      <button id="accountBtn" class="btn btn-link" type="button" aria-haspopup="menu" aria-expanded="false">üåê</button>
      <div id="acctMenu" class="acct-menu" role="menu" aria-hidden="true">
        <div class="acct-header">
          <div class="acct-avatar" id="acctAvatar" aria-hidden="true">U</div>
          <div class="acct-id">
            <div class="acct-name" id="acctName">User</div>
            <div class="acct-email" id="acctEmail">you@example.com</div>
          </div>
        </div>
        <button class="acct-item" role="menuitem" id="acctViewBtn">View account</button>
        <button class="acct-item" role="menuitem" id="acctChangeUnameBtn">Change username</button>
        <button class="acct-item danger" role="menuitem" id="acctSignOutBtn">Sign out</button>
      </div>
    </div>
  </nav>

  <!-- Home -->
  <section id="home" class="section">
    <h1>Welcome</h1>
  </section>

  <!-- Settings -->
  <section id="settings" class="section">
    <h2>Settings</h2>
    <div class="audioControl">
      <button type="button" id="toggleMusicBtn">Play / Pause Music</button>
      <label for="volumeSlider">Volume:</label>
      <input type="range" min="0" max="1" step="0.01" id="volumeSlider" />
      <button type="button" id="toggleThemeBtn">Toggle Dark Theme</button>
      <div class="shortcuts-wrap" style="margin-top:14px; font-size:14px; opacity:.9; text-align:left">
        <strong>Keyboard shortcuts</strong>
        <ul style="list-style: none; padding-left: 0; line-height:1.7;">
          <li><kbd>H</kbd> Home &nbsp; <kbd>E</kbd> Settings</li>
          <li><kbd>M</kbd> Play/Pause music &nbsp; <kbd>T</kbd> Toggle dark theme</li>
          <li><kbd>A</kbd> Account &nbsp; <kbd>Esc</kbd> Close modal</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Account / Auth Modal -->
  <div class="modal" id="authModal" role="dialog" aria-modal="true" aria-labelledby="authTitle" aria-hidden="true">
    <div class="modal-content" style="max-width:520px;" tabindex="-1">
      <h2 id="authTitle">Sign in</h2>
      <button type="button" class="btn" id="googleSignInBtn">Continue with Google</button>
      <div class="dividerOr" style="margin:10px 0; opacity:.6;">or</div>
      <form id="emailAuthForm" onsubmit="return false;">
        <label for="authEmail">Email</label><br />
        <input id="authEmail" type="email" placeholder="you@example.com" required /><br /><br />
        <label for="authPass">Password</label><br />
        <input id="authPass" type="password" minlength="6" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required /><br /><br />
        <div style="display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
          <button type="button" class="btn" id="emailSignInBtn">Sign in</button>
          <button type="button" class="btn" id="emailSignUpBtn">Create account</button>
          <button type="button" class="btn" id="resetBtn" title="Reset password via email">Reset password</button>
        </div>
      </form>
      <div id="authError" style="color:#c0392b; margin-top:10px; min-height:1.2em;"></div>
      <br />
      <button type="button" class="btn" id="closeAuthModalBtn">Close</button>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Music -->
  <audio id="bgMusic" loop>
    <source src="ALONE.mp3" type="audio/mpeg" />
    Your browser does not support audio.
  </audio>

  <!-- Signed-in indicator -->
  <div id="whoami" class="copyright"></div>
  <div class="copyright">¬© 2025 ME100</div>

  <!-- Firebase and Site Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider,
      signOut, signInWithEmailAndPassword, createUserWithEmailAndPassword,
      sendPasswordResetEmail, sendEmailVerification
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
    import {
      getFirestore, doc, setDoc, getDoc, runTransaction, deleteDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBUBMX0Nkaml4BoDgTBZsLv15rXd4-yaB0",
      authDomain: "me100-shoop.firebaseapp.com",
      projectId: "me100-shoop",
      storageBucket: "me100-shoop.firebasestorage.app",
      messagingSenderId: "1043376017039",
      appId: "1:1043376017039:web:5606b92f696854658faafa",
      measurementId: "G-LVBT7HM50B"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (sel) => document.querySelector(sel);
    const authModal = $("#authModal"), accountBtn = $("#accountBtn"), whoami = $("#whoami");
    const acctMenu = $("#acctMenu");
    let acctMenuOpen = false;
    let lastFocusGlobal = null;

    function showToast(msg) {
      const toastEl = $("#toast");
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 2200);
    }

    function activateFocusTrap(modal) {
      const f = modal.querySelectorAll('button,[href],input,select,textarea,[tabindex]:not([tabindex="-1"])');
      if (!f.length) return;
      const first = f[0], last = f[f.length - 1];
      modal.__trapHandler = (e) => {
        if (e.key === 'Tab') {
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault();
            last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault();
            first.focus();
          }
        } else if (e.key === 'Escape') {
          if (modal.id === 'authModal') closeAuthModal();
        }
      };
      modal.addEventListener('keydown', modal.__trapHandler);
    }

    function deactivateFocusTrap(modal) {
      if (modal.__trapHandler) {
        modal.removeEventListener('keydown', modal.__trapHandler);
        modal.__trapHandler = null;
      }
    }

    function setAcctMenuVisibility(show) {
      acctMenuOpen = show;
      acctMenu.setAttribute('aria-hidden', String(!show));
      accountBtn.setAttribute('aria-expanded', String(show));
      acctMenu.classList.toggle('show', show);
      if (show) {
        $("#acctViewBtn")?.focus();
      }
    }

    function toggleAcctMenu() {
      setAcctMenuVisibility(!acctMenuOpen);
    }

    function closeAcctMenuIfOutside(e) {
      if (!acctMenuOpen) return;
      const withinMenu = acctMenu.contains(e.target);
      const onBtn = accountBtn.contains(e.target);
      if (!withinMenu && !onBtn) setAcctMenuVisibility(false);
    }

    function showAuthModal() {
      authModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
      requestAnimationFrame(() => {
        authModal.classList.add('show');
        authModal.setAttribute('aria-hidden', 'false');
        activateFocusTrap(authModal);
        ($("#googleSignInBtn") || authModal.querySelector('button, input'))?.focus();
      });
    }

    function closeAuthModal() {
      deactivateFocusTrap(authModal);
      authModal.classList.remove('show');
      authModal.setAttribute('aria-hidden', 'true');
      document.body.style.overflow = '';
      setTimeout(() => {
        authModal.style.display = 'none';
      }, 300);
      lastFocusGlobal?.focus?.();
    }

    async function ensureProfile(uid, email) {
      const pRef = doc(db, 'profiles', uid);
      const snap = await getDoc(pRef);
      if (!snap.exists()) {
        await setDoc(pRef, {
          email,
          username: null,
          lastUsernameChange: null,
          createdAt: serverTimestamp()
        });
      }
    }

    async function loadAccountPanel() {
      const user = auth.currentUser;
      if (!user) return;
      await ensureProfile(user.uid, user.email || null);

      const pRef = doc(db, 'profiles', user.uid);
      const profile = (await getDoc(pRef)).data() || {};
      const name = user.displayName || (user.email ? user.email.split("@")[0] : "User");
      const email = user.email || "";
      const usesPassword = (user.providerData || []).some(p => p.providerId === "password");
      const verifyNeeded = usesPassword && !user.emailVerified;

      $("#authTitle").innerText = "Your account";
      $("#emailAuthForm").style.display = "none";
      $("#googleSignInBtn").style.display = "none";
      document.querySelector('#authModal .modal-content .accountBox')?.remove();
      document.querySelector('#authModal .modal-content .dividerOr')?.remove();
      $("#signoutArea")?.remove();

      const lastChange = profile.lastUsernameChange?.toDate ? profile.lastUsernameChange.toDate() : null;
      const daysLeft = lastChange ? Math.max(0, 30 - Math.floor((Date.now() - lastChange.getTime()) / 86400000)) : 0;
      const disableEdit = daysLeft > 0;

      const accountHTML = `
        <div class="accountBox" style="margin-top:6px; text-align:left;">
          <div style="font-weight:800; font-size:18px;">${name}</div>
          <div style="opacity:.85; margin-bottom:10px;">${email}</div>
          <div style="display:flex; align-items:center; gap:8px; margin:8px 0;">
            <div><strong>Username:</strong> ${profile.username ? <code>${profile.username}</code> : <em>not set</em>}</div>
          </div>
          <div style="margin-top:6px; padding:12px; border-radius:10px; background:rgba(0,0,0,.04);">
            <label for="newUsername"><strong>Set / Change username</strong> (digits only 0‚Äì9, 1‚Äì7)</label><br/>
            <div style="display:flex; gap:8px; margin-top:6px; align-items:center;">
              <input id="newUsername" type="text" inputmode="numeric" pattern="\\d{1,7}" placeholder="e.g. 777" value="${profile.username ?? ''}" ${disableEdit ? 'disabled' : ''} style="flex:1; padding:8px 10px; border-radius:8px; border:1px solid #ccc;" />
              <button id="saveUsernameBtn" class="btn" ${disableEdit ? 'disabled' : ''}>Save</button>
            </div>
            <div id="usernameMsg" style="margin-top:6px; font-size:13px; color:${disableEdit ? '#7a5a00' : '#555'};">
              ${disableEdit ? You can change again in ${daysLeft} day${daysLeft === 1 ? '' : 's'}. : Your username must be unique. Once changed, you must wait 30 days.}
            </div>
          </div>
          ${verifyNeeded ? `
            <div id="verifyBanner" style="margin-top:12px; padding:10px; border-radius:8px; background:#fff3cd; color:#7a5a00;">
              Email not verified.
              <button id="resendVerifyBtn" class="btn" style="margin-left:6px;">Resend verification</button>
              <div style="font-size:12px; margin-top:6px; opacity:.9">Tip: check Spam/Promotions.</div>
            </div>` : ``}
        </div>
        <div id="signoutArea" style="margin-top:12px; text-align:center;">
          <button type="button" class="btn" id="signOutBtn">Sign out</button>
        </div>`;

      $("#authModal .modal-content").insertAdjacentHTML("beforeend", accountHTML);

      $("#signOutBtn").onclick = async () => {
        await signOut(auth);
        closeAuthModal();
        showToast("Signed out");
      };
      $("#resendVerifyBtn")?.addEventListener("click", async () => {
        try {
          await sendEmailVerification(auth.currentUser);
          showToast("Verification email sent");
        } catch (e) {
          $("#authError").textContent = e?.message || "Could not send verification email.";
        }
      });
      $("#saveUsernameBtn")?.addEventListener("click", async () => {
        const val = ($("#newUsername").value || "").trim();
        const re = /^\d{1,7}$/;
        if (!re.test(val)) {
          $("#usernameMsg").textContent = "Username must be 1‚Äì7 digits (0‚Äì9).";
          return;
        }
        try {
          await changeUsernameTransaction(val);
          showToast("Username saved");
          closeAuthModal();
        } catch (err) {
          $("#usernameMsg").textContent = err?.message || "Could not save username.";
        }
      });
    }

    async function changeUsernameTransaction(newName) {
      const user = auth.currentUser;
      if (!user) throw new Error("Not signed in.");

      const pRef = doc(db, 'profiles', user.uid);
      const unameRef = doc(db, 'usernames', newName);

      await runTransaction(db, async (tx) => {
        const pSnap = await tx.get(pRef);
        const now = new Date();

        if (!pSnap.exists()) {
          tx.set(pRef, { email: user.email || null, username: null, lastUsernameChange: null, createdAt: serverTimestamp() });
        }
        const p = pSnap.exists() ? pSnap.data() : {};
        const lastChange = p.lastUsernameChange?.toDate ? p.lastUsernameChange.toDate() : null;
        if (lastChange) {
          const diffDays = (now - lastChange) / 86400000;
          if (diffDays < 30) throw new Error(You can change your username again in ${Math.ceil(30 - diffDays)} day(s).);
        }

        const unameSnap = await tx.get(unameRef);
        if (unameSnap.exists() && unameSnap.data().uid !== user.uid) {
          throw new Error("That username is already taken.");
        }

        const prev = p.username;
        if (prev && prev !== newName) {
          const prevRef = doc(db, 'usernames', prev);
          const prevSnap = await tx.get(prevRef);
          if (prevSnap.exists() && prevSnap.data().uid === user.uid) {
            tx.delete(prevRef);
          }
        }

        tx.set(unameRef, { uid: user.uid, claimedAt: serverTimestamp() });
        tx.set(pRef, {
          email: user.email || null,
          username: newName,
          lastUsernameChange: serverTimestamp(),
          updatedAt: serverTimestamp()
        }, { merge: true });
      });
    }

    function openAuthModal() {
      lastFocusGlobal = document.activeElement;
      $("#authError").textContent = "";
      document.querySelector('#authModal .modal-content .accountBox')?.remove();
      $("#signoutArea")?.remove();

      const user = auth.currentUser;
      if (user) {
        loadAccountPanel().then(showAuthModal);
      } else {
        $("#authTitle").innerText = "Sign in";
        $("#emailAuthForm").style.display = "block";
        $("#googleSignInBtn").style.display = "inline-block";
        if (!document.querySelector('#authModal .modal-content .dividerOr')) {
          const div = document.createElement('div');
          div.className = 'dividerOr';
          div.style.cssText = 'margin:10px 0; opacity:.6;';
          div.textContent = 'or';
          $("#authModal .modal-content").insertBefore(div, $("#emailAuthForm"));
        }
        showAuthModal();
      }
    }

    function showAuthError(err) {
      const map = {
        "auth/popup-closed-by-user": "Sign-in window was closed.",
        "auth/account-exists-with-different-credential": "This email is linked to another sign-in method.",
        "auth/invalid-credential": "Invalid credentials.",
        "auth/invalid-login-credentials": "Invalid email or password.",
        "auth/email-already-in-use": "Email already in use.",
        "auth/weak-password": "Password should be at least 6 characters."
      };
      $("#authError").textContent = map[err?.code] || err?.message || "Something went wrong.";
    }

    document.addEventListener('click', closeAcctMenuIfOutside);
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') setAcctMenuVisibility(false);
    });

    $("#accountBtn").addEventListener('click', () => {
      const signedIn = !!auth.currentUser;
      if (signedIn) {
        toggleAcctMenu();
      } else {
        openAuthModal();
      }
    });

    $("#googleSignInBtn")?.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
        setAcctMenuVisibility(false);
        closeAuthModal();
        showToast("Signed in with Google");
      } catch (e) {
        showAuthError(e);
      }
    });

    $("#emailSignInBtn")?.addEventListener("click", async () => {
      const email = $("#authEmail").value.trim(), pass = $("#authPass").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
        setAcctMenuVisibility(false);
        closeAuthModal();
        showToast("Signed in");
      } catch (e) {
        showAuthError(e);
      }
    });

    $("#emailSignUpBtn")?.addEventListener("click", async () => {
      const email = $("#authEmail").value.trim(), pass = $("#authPass").value;
      try {
        await createUserWithEmailAndPassword(auth, email, pass);
        try {
          await sendEmailVerification(auth.currentUser);
        } catch {}
        setAcctMenuVisibility(false);
        closeAuthModal();
        showToast("Account created ‚Äî verify your email (check Spam)");
      } catch (e) {
        showAuthError(e);
      }
    });

    $("#resetBtn")?.addEventListener("click", async () => {
      const email = $("#authEmail").value.trim();
      if (!email) {
        $("#authError").textContent = "Enter your email above first.";
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        $("#authError").textContent = "";
        showToast("Password reset email sent");
      } catch (e) {
        showAuthError(e);
      }
    });

    $("#closeAuthModalBtn")?.addEventListener("click", closeAuthModal);

    $("#acctViewBtn")?.addEventListener("click", () => {
      openAuthModal();
      setAcctMenuVisibility(false);
    });

    $("#acctChangeUnameBtn")?.addEventListener("click", () => {
      openAuthModal();
      setAcctMenuVisibility(false);
    });

    onAuthStateChanged(auth, (user) => {
      const btn = $("#accountBtn");
      if (user) {
        const name = user.displayName || (user.email ? user.email.split("@")[0] : "User");
        const email = user.email || "";
        const initials = (name?.trim()?.[0] || 'U').toUpperCase();

        btn.classList.add('account-chip');
        btn.innerHTML = <span class="chip-avatar">${initials}</span><span>${(name.split("@")[0] || "Account")}</span>;
        $("#acctAvatar").textContent = initials;
        $("#acctName").textContent = name;
        $("#acctEmail").textContent = email;
        whoami && (whoami.textContent = Signed in as ${name});
      } else {
        btn.classList.remove('account-chip');
        btn.innerHTML = 'üåê';
        setAcctMenuVisibility(false);
        whoami && (whoami.textContent = "");
      }
    });

    // Theme initialization
    (function initTheme() {
      try {
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        if ((saved === 'dark') || (!saved && prefersDark)) document.body.classList.add('dark');
      } catch (e) {}
    })();

    $("#toggleThemeBtn")?.addEventListener('click', () => {
      const dark = document.body.classList.toggle('dark');
      try {
        localStorage.setItem('theme', dark ? 'dark' : 'light');
      } catch (e) {}
    });

    // Navigation
    (function revealOnScroll() {
      const io = new IntersectionObserver((entries) => {
        entries.forEach(e => {
          if (e.isIntersecting) e.target.classList.add('visible');
        });
      }, { rootMargin: '0px 0px -100px 0px' });
      document.querySelectorAll('.section').forEach(s => io.observe(s));
    })();

    (function activeNavInit() {
      const sections = [...document.querySelectorAll('.section')];
      const links = [...document.querySelectorAll('.nav-link')];
      const byId = Object.fromEntries(links.map(l => [l.dataset.target, l]));
      const navIO = new IntersectionObserver(es => {
        es.forEach(e => {
          if (e.isIntersecting) {
            links.forEach(l => l.removeAttribute('aria-current'));
            byId[e.target.id]?.setAttribute('aria-current', 'true');
          }
        });
      }, { threshold: 0.5 });
      sections.forEach(s => navIO.observe(s));
    })();

    $("#brandHome").addEventListener('click', () => {
      const brand = $("#brandHome");
      brand.classList.add('bounce');
      setTimeout(() => brand.classList.remove('bounce'), 300);
      $("#home").scrollIntoView({ behavior: 'smooth', block: 'start' });
      setTimeout(() => {
        const s = $("#home");
        s.classList.add('target-pulse');
        setTimeout(() => s.classList.remove('target-pulse'), 800);
      }, 200);
      const menu = $("#mainmenu");
      const btn = $(".menu-toggle");
      if (menu.classList.contains('show')) {
        menu.classList.remove('show');
        btn.setAttribute('aria-expanded', 'false');
      }
    });

    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', (e) => {
        if (e.metaKey || e.ctrlKey || e.shiftKey) return;
        e.preventDefault();
        link.classList.add('clicked');
        setTimeout(() => link.classList.remove('clicked'), 400);
        const id = link.getAttribute('data-target');
        const section = document.getElementById(id);
        if (section) {
          section.scrollIntoView({ behavior: 'smooth', block: 'start' });
          setTimeout(() => {
            section.classList.add('target-pulse');
            setTimeout(() => section.classList.remove('target-pulse'), 800);
          }, 200);
        }
        const menu = $("#mainmenu");
        const btn = $(".menu-toggle");
        if (menu.classList.contains('show')) {
          menu.classList.remove('show');
          btn.setAttribute('aria-expanded', 'false');
        }
      });
    });

    $(".menu-toggle")?.addEventListener('click', () => {
      const menu = $("#mainmenu");
      const btn = $(".menu-toggle");
      const open = menu.classList.toggle("show");
      btn.setAttribute("aria-expanded", String(open));
    });

    // Audio controls
    $("#toggleMusicBtn")?.addEventListener('click', () => {
      const music = $("#bgMusic");
      if (music.paused) {
        music.play().catch(() => {});
      } else {
        music.pause();
      }
    });

    $("#volumeSlider")?.addEventListener('change', (e) => {
      $("#bgMusic").volume = parseFloat(e.target.value);
    });

    // Keyboard shortcuts
    window.addEventListener('keydown', (e) => {
      const tag = (e.target.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea') return;
      const key = e.key.toLowerCase();
      if (key === 'h') {
        $("#home").scrollIntoView({ behavior: 'smooth' });
      } else if (key === 'e') {
        $("#settings").scrollIntoView({ behavior: 'smooth' });
      } else if (key === 'm') {
        const music = $("#bgMusic");
        if (music.paused) {
          music.play().catch(() => {});
        } else {
          music.pause();
        }
      } else if (key === 't') {
        const dark = document.body.classList.toggle('dark');
        try {
          localStorage.setItem('theme', dark ? 'dark' : 'light');
        } catch (e) {}
      } else if (key === 'a') {
        openAuthModal();
      } else if (key === 'escape') {
        const authOpen = $("#authModal").classList.contains('show');
        if (authOpen) closeAuthModal();
      }
    });

    // Konami code
    const seq = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
    let pos = 0;
    window.addEventListener('keydown', (e) => {
      const key = e.key.length === 1 ? e.key.toLowerCase() : e.key;
      const normalized = (key.length === 1) ? key : e.key;
      pos = (normalized === seq[pos]) ? pos + 1 : (normalized === seq[0] ? 1 : 0);
      if (pos === seq.length) {
        document.body.style.background = 'linear-gradient(120deg,#6dc8eb,#66c2ef)';
        pos = 0;
      }
    });
  </script>
</body>
</html>
